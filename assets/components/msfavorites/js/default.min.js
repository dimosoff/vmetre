!function(p){"use strict";function t(t,a){return function(){return t.apply(a,arguments)}}function o(t){return t.replace(/(-|\.)(\w)/g,function(t,a){return a.toUpperCase()})}function s(e,t,a){var s,i;if(void 0===t&&(t=p.fn.msfavorites.defaults.ns),s=o(t),i=e.data("msFavorites"),p.each(a,function(t,a){e.data(s+"-"+t,a)}),i)switch(s){case"data":i.data=p.extend(!0,i.data,a);break;case"options":i.options=p.extend(!0,i.options,a)}return a}function n(t,a){var s,i;return void 0===a&&(a=p.fn.msfavorites.defaults.ns),s=o(a),i=t.data(s)||{},p.each(t.data(),function(t,a){if(0===t.indexOf(s)){var e=t.replace(s,"").replace(/[A-Z]/g,function(t,a){return(0==a?"":"-")+t.toLowerCase()});0<e.length&&(i[e]=a)}}),i}function i(t,a){if("function"==typeof t)return t.apply(a,Array.prototype.slice.call(arguments,2));if("object"==typeof t)for(var e in t){if(t.hasOwnProperty(e))if(!1===t[e].apply(a,Array.prototype.slice.call(arguments,2)))return!1}return!0}var r,d,l={service:"msfavorites",version:document.head.querySelector('meta[name="msfavorites:version"]').content,ctx:document.head.querySelector('meta[name="msfavorites:ctx"]').content,actionUrl:document.head.querySelector('meta[name="msfavorites:actionUrl"]').content},c=[].indexOf||function(t){for(var a=0,e=this.length;a<e;a++)if(a in this&&this[a]===t)return a;return-1},a=[].slice;function e(){}r=["extended","included"],e.extend=function(t){var a,e,s;for(a in t)s=t[a],c.call(r,a)<0&&(this[a]=s);return null!=(e=t.extended)&&e.apply(this),this},e.include=function(t){var a,e,s;for(a in t)s=t[a],c.call(r,a)<0&&(this.prototype[a]=s);return null!=(e=t.included)&&e.apply(this),this},(d=function(t,a){this.defaults=p.fn.msfavorites.defaults,this.selectors=p.fn.msfavorites.selectors,this.$body=p("body"),this.$element=p(t),this.$parent=this.$element.closest(this.selectors.parent),this.$parent.length<1&&(this.$parent=p("body")),this.options=p.extend(!0,{},n(this.$parent),a),this.data=p.extend(!0,{service:l.service,ctx:l.ctx,list:"default",type:"resource"},n(this.$parent,"data"),n(this.$element,"data")),this.data.list.trim()||(this.data.list="default"),this.data.type.trim()||(this.data.type="resource"),this.cacheKey=this.data.list+"."+this.data.type}).prototype={constructor:d,init:function(){this.processSuccess=t(this.processSuccess,this),this.processFailure=t(this.processFailure,this),this.processAction=t(this.processAction,this),this.addMethodAction=t(this.addMethodAction,this),this.removeMethodAction=t(this.removeMethodAction,this)},getStorage:function(t){var a=this.$body.data("msFavoritesStorage")||{};return null!=t?a[t]?a[t]:null:a},setStorage:function(t,a){var e=this.$body.data("msFavoritesStorage")||{};null!=t?e[t]=a:e=a,this.$body.data("msFavoritesStorage",e)},loadFavorites:function(t){var r=[];p(p.fn.msfavorites.selectors.main).each(function(t,a){var e=p(a),s=e.data("data-id")||"",i=e.data("data-list")||"default",o=e.data("data-type")||"resource",n=e.data("data-key")||"";!n&&s&&(n=s),p.each(e.find(p.fn.msfavorites.selectors.total).not("[data-data-list]"),function(){var t=p(this);t.data("data-list",i),t.attr("data-data-list",i)}),p.each(e.find(p.fn.msfavorites.selectors.total).not("[data-data-type]"),function(){var t=p(this);t.data("data-type",o),t.attr("data-data-type",o)}),p.each(e.find(p.fn.msfavorites.selectors.totalUser).not("[data-data-list]"),function(){var t=p(this);t.data("data-list",i),t.attr("data-data-list",i)}),p.each(e.find(p.fn.msfavorites.selectors.totalUser).not("[data-data-type]"),function(){var t=p(this);t.data("data-type",o),t.attr("data-data-type",o)}),n&&p.each(e.find(p.fn.msfavorites.selectors.totalUser).not("[data-data-key]"),function(){var t=p(this);t.data("data-key",n),t.attr("data-data-key",n)}),e.data("data-key",n),e.attr("data-data-key",n),e.data("data-list",i),e.attr("data-data-list",i),e.data("data-type",o),e.attr("data-data-type",o),r[i+"|"+o]={list:i,type:o}}),p.each(p(document).find(p.fn.msfavorites.selectors.total).not("[data-data-type]"),function(){var t=p(this);t.data("data-type","resource"),t.attr("data-data-type","resource")}),p.each(p(document).find(p.fn.msfavorites.selectors.totalAll).not("[data-data-type]"),function(){var t=p(this);t.data("data-type","resource"),t.attr("data-data-type","resource")});var a,e,s;for(a in r)r.hasOwnProperty(a)&&(e=r[a].list+"|"+r[a].type,!t&&(s=this.getStorage(e))?this.updateFavorites(s,"get"):(s=p.extend(!0,{service:l.service,ctx:l.ctx},{action:"favorites/multiple",method:"get",list:r[a].list,type:r[a].type}),p.ajax({url:l.actionUrl,type:"get",dataType:"json",cache:!1,data:s}).done(function(a){return function(t){e=t.data.meta.list+"|"+t.data.meta.type,a.processSuccess(t,s),a.setStorage(e,t.data),a.updateFavorites(t.data,"get")}}(this)).fail(function(a){return function(t){e=t.data.meta.list+"|"+t.data.meta.type,a.processFailure(t,s),a.setStorage(e,t.data)}}(this))))},updateFavorites:function(t,a,e){var s,i,o,n,r,d,l,c,f,u=(t=t||{}).result||{},m=t.meta||{},h=u.keys||{},v=u.users||{};switch(s=this.$parent.parent(),i=p(p.fn.msfavorites.selectors.main),o=p(p.fn.msfavorites.selectors.total),n=p(p.fn.msfavorites.selectors.totalAll),r=p(p.fn.msfavorites.selectors.totalUser),p.each(i.not(this.defaults.cls.load),(d=this,function(){var t=p(this),a=t.data("data-list"),e=t.data("data-type"),s=t.data("data-key");m.list===a&&m.type===e&&(h[s]?t.addClass(d.defaults.cls.load).addClass(d.defaults.cls.voted):t.addClass(d.defaults.cls.load).removeClass(d.defaults.cls.voted))})),p.each(o,(l=this,function(){var t=p(this),a=t.data("data-list"),e=t.data("data-type");m.list===a&&m.type===e&&(t.addClass(l.defaults.cls.load),setTimeout(function(){t.text(m.total),t.attr("data-value",m.total)},200))})),p.each(n,(c=this,function(){var t=p(this),a=t.data("data-list"),e=t.data("data-type");m.list===a&&m.type===e&&(t.addClass(c.defaults.cls.load),t.hasClass(c.defaults.cls.visible)||(m.total<1?t.hide():t.show()))})),p.each(r,(f=this,function(){var t=p(this),a=t.data("data-list"),e=t.data("data-type"),s=t.data("data-key");if(m.list===a&&m.type===e){t.addClass(f.defaults.cls.load);var i=v[s]||0;setTimeout(function(){t.text(i),t.attr("data-value",i)},200)}})),!0){case"list"===this.options.mode&&"remove"===a:this.$parent.remove(),s.find(this.selectors.parent).length<1&&location.reload();break;case"clear"===a:this.$element.data("data-list")&&t.meta.list&&!t.result.keys.length&&(this.$parent.remove(),location.reload())}},processAction:function(){var t,e,s,a,i;e=this.$element.hasClass(this.defaults.cls.action)?this.data.method:this.$element.hasClass(this.defaults.cls.voted)?"remove":"add",s=p.extend(!0,this.data,{action:"favorites/multiple",method:e}),t=p.Event(p.fn.msfavorites.PROCESS_ACTION),this.$element.trigger(t,[s]),t.isDefaultPrevented()||(this.$element.removeClass(this.defaults.cls.load).removeClass(this.defaults.cls.voted),p.ajax({url:l.actionUrl,type:"post",dataType:"json",cache:!1,data:s}).done((i=this,function(t){var a=t.data.meta.list+"|"+t.data.meta.type;i.processSuccess(t,s),i.setStorage(a,t.data),i.updateFavorites(t.data,e)})).fail((a=this,function(t){a.processFailure(t,s)})))},processSuccess:function(t,a){var e,s;if(e=p.Event(p.fn.msfavorites.PROCESS_SUCCESS),this.$element.trigger(e,[t,a]),!e.isDefaultPrevented())return t.success||(s=(s=t.message)||"error unknown",console.log(s)),i(p.fn.msfavorites.methodActions.success,this,t),!0},processFailure:function(t,a){var e,s;if(e=p.Event(p.fn.msfavorites.PROCESS_FAILURE),this.$element.trigger(e,[t,a]),!e.isDefaultPrevented())return s=(s=t.responseJSON)||"error unknown",console.log(s),i(p.fn.msfavorites.methodActions.failure,this,t.responseJSON),!1},addMethodAction:function(t,a,e){return"function"==typeof e&&(p.fn.msfavorites.methodActions[t]||(p.fn.msfavorites.methodActions[t]={}),p.fn.msfavorites.methodActions[t][a]=e,!0)},removeMethodAction:function(t,a){return p.fn.msfavorites.methodActions[t]||(p.fn.msfavorites.methodActions[t]={}),delete p.fn.msfavorites.methodActions[t][a],!0}},p.fn.msfavorites=function(){var i,o;return o=arguments[0],i=2<=arguments.length?a.call(arguments,1):[],this.each(function(){var t,a,e,s;if((e=(t=p(this)).data("msFavorites"))||((a=t.closest(p.fn.msfavorites.selectors.parent)).length<1&&(a=p("body")),(s=p.extend(!0,{},n(a),n(t))).mode,(e=new d(this,s))&&(t.data("msFavorites",e),e.init())),"string"==typeof o)return e[o].apply(e,i)})},p.fn.msfavorites.CONTENT_CHANGE="msfavorites:content-change.msfavorites",p.fn.msfavorites.PROCESS_SUCCESS="msfavorites:process-success.msfavorites",p.fn.msfavorites.PROCESS_FAILURE="msfavorites:process-failure.msfavorites",p.fn.msfavorites.PROCESS_ACTION="msfavorites:process-action.msfavorites",p.fn.msfavorites.defaults={ns:"msfavorites",cls:{load:"load",voted:"voted",visible:"visible",action:"msfavorites-action",animation:"msfavorites-animation"},timeout:300},p.fn.msfavorites.selectors={main:"."+p.fn.msfavorites.defaults.ns,total:"."+p.fn.msfavorites.defaults.ns+"-total",totalAll:"."+p.fn.msfavorites.defaults.ns+"-total-all",totalUser:"."+p.fn.msfavorites.defaults.ns+"-total-user",parent:"."+p.fn.msfavorites.defaults.ns+"-parent",actionClick:"[data-click]",actionFormSubmit:"[data-formsubmit]",actionFormChange:"[data-formchange]"},p.fn.msfavorites.methodActions={success:{animation:function(t){var a;if(this.data&&this.data.method&&"add"===this.data.method&&(this.options&&this.options.animation&&(a=p(p.fn.msfavorites.selectors.totalAll).filter("[data-msfavorites-animation]").filter('[data-data-list="'+this.data.list+'"]'))&&a.length)){var e={start:this.$element.offset(),end:a.offset()};p("<img/>",{src:this.options.animation,class:this.defaults.cls.animation}).css({position:"absolute","z-index":"9999","background-size":"cover",top:e.start.top||0,left:e.start.left||0}).appendTo("body").animate({top:e.end.top||0,left:e.end.left||0,opacity:"toggle"},1e3,function(){p(this).remove()})}}},failure:{"set.cls.load":function(t){this.$element&&this.defaults.cls&&this.$element.addClass(this.defaults.cls.load)},"miniShop2.Message.initialize":function(t){"object"==typeof miniShop2&&(miniShop2.Message.initialize(),t&&t.message&&miniShop2.Message.error(t.message))}}},p(document).on("click",p.fn.msfavorites.selectors.main+p.fn.msfavorites.selectors.actionClick,function(t){var a=p(this);if(a.is("a")&&t.preventDefault(),a.is("form")){var e={};p.map(a.serializeArray()||[],function(t,a){e[t.name]=t.value}),s(a,"data",e)}a.msfavorites("processAction")}),p(document).on("submit",p.fn.msfavorites.selectors.main+p.fn.msfavorites.selectors.actionFormSubmit,function(t){var a=p(this),e={};t.preventDefault(),p.map(a.serializeArray()||[],function(t,a){e[t.name]=t.value}),s(a,"data",e),a.msfavorites("processAction")}),p(document).on("change",p.fn.msfavorites.selectors.main+p.fn.msfavorites.selectors.actionFormChange,function(t){var a=p(this),e={};t.preventDefault(),p.map(a.serializeArray()||[],function(t,a){e[t.name]=t.value}),s(a,"data",e),a.msfavorites("processAction")});var f=0;p(document).on(p.fn.msfavorites.CONTENT_CHANGE,function(t,a){a&&"string"==typeof a&&a.match(new RegExp(p.fn.msfavorites.defaults))&&(p(p.fn.msfavorites.selectors.main).msfavorites(),f&&clearTimeout(f),f=setTimeout(function(){f=0,p("body").msfavorites("loadFavorites")},500))}),p(window).on("load",function(){p("body").msfavorites("loadFavorites",!0),p(p.fn.msfavorites.selectors.main).msfavorites(),p("body").on("DOMNodeInserted",function(t){var a;t.target&&(a=t.target.innerHTML)&&"string"==typeof a&&a.match(new RegExp(p.fn.msfavorites.defaults))&&p(document).trigger(p.fn.msfavorites.CONTENT_CHANGE,jQuery.merge([a],arguments))})}),window.msFavorites=new d(null,l.options)}(window.jQuery);